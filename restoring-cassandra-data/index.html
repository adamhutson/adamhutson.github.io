<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Adam Hutson">
    <meta name="description" content="Adam Hutson&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Restoring Cassandra Data"/>
<meta name="twitter:description" content="If you’ve ever lost your production data or discovered that it had been corrupted, then you know the importance of being able to restore that data. Restoring your Cassandra data can be quick and painless. The following three methods will help you to gain a better understanding of what’s involved.
 Before you can begin to restore data though you have to have data to restore. You are backing up your data, right?"/>

    <meta property="og:title" content="Restoring Cassandra Data" />
<meta property="og:description" content="If you’ve ever lost your production data or discovered that it had been corrupted, then you know the importance of being able to restore that data. Restoring your Cassandra data can be quick and painless. The following three methods will help you to gain a better understanding of what’s involved.
 Before you can begin to restore data though you have to have data to restore. You are backing up your data, right?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://adamhutson.com/restoring-cassandra-data/" />
<meta property="article:published_time" content="2016-04-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-04-08T00:00:00+00:00" />


    
      <base href="http://adamhutson.com/restoring-cassandra-data/">
    
    <title>
  Restoring Cassandra Data · Adam Hutson
</title>

    
      <link rel="canonical" href="http://adamhutson.com/restoring-cassandra-data/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="http://adamhutson.com/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="http://adamhutson.com/css/coder-inverted.min.9e2c96f8fa9eaf53cac36cea2d330e990ea903e02e7b2843e916e09da8724be4.css" integrity="sha256-niyW&#43;Pqer1PKw2zqLTMOmQ6pA&#43;AueyhD6RbgnahyS&#43;Q=" crossorigin="anonymous" media="screen" />
      
    

    

    
    
    <link rel="icon" type="image/png" href="http://adamhutson.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://adamhutson.com/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.59.1" />
  </head>

  <body class=" inverted">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://adamhutson.com/">
      Adam Hutson
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://adamhutson.com/about/">About</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://adamhutson.com/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://adamhutson.com/resume/">Resume</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://adamhutson.com/talks/">Talks</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://adamhutson.com/contact/">Contact</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Restoring Cassandra Data</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2016-04-08T00:00:00Z'>
                April 8, 2016
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5 minutes read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        <div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="http://adamhutson.com/images/restore.jpg" alt="restore">
</div>
</div>
<div class="paragraph">
<p>If you’ve ever lost your production data or discovered that it had been corrupted, then you know the importance of being able to restore that data.
Restoring your Cassandra data can be quick and painless.
The following three methods will help you to gain a better understanding of what’s involved.</p>
</div>
<div class="paragraph">
<p>Before you can begin to restore data though you have to have data to restore.
You are backing up your data, right?
If not, check out our post on backing up Cassandra data.
Once you’re sure your data is safely backed up, then you can focus on how to restore it.</p>
</div>
<div class="paragraph">
<p>Currently, Apache Cassandra provides three methods to restore data from a snapshot (Cassandra’s term for a backup):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restart the service</p>
</li>
<li>
<p>Refresh the data</p>
</li>
<li>
<p>Use the sstableloader tool</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of these methods will ultimately restore data to a node.
However, each has a different set of circumstances for when to use.
It’s important to know when to use each.
This post will describe each method in detail and what dictates the choice of each.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_restart_the_service">Restart the Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>What is it:</strong>
The first restore method involves restarting the Cassandra service.
You’re essentially shutting down a node to replace all the bad data with the backed up data.</p>
</div>
<div class="paragraph">
<p><strong>When to use it:</strong>
Restarting the service is going to cover your most common situations for needing to restore data.
This is for when you’ve got a node that has gone down, or has corrupted it’s data in some fashion.
This is for the machine that has already been a Cassandra node and will be continue to be.</p>
</div>
<div class="paragraph">
<p><strong>Steps to do it:</strong>
A simple restart doesn’t do it all for you.
You have to get rid of all the bad data first.
This method will have you erase all traces of the bad data that was on the machine.
Once it’s all cleaned up, you’ll move all the backed up data into place.
Finally, a restart of the service will get all of the data back into the cluster.
It also recreates all the necessary stuff that you cleaned up.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the Cassandra service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo service cassandra stop</code></pre>
</div>
</div>
</li>
<li>
<p>Run the nodetool drain command to flush all data from memtables to disk.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">nodetool drain</code></pre>
</div>
</div>
</li>
<li>
<p>Delete all the commit log files.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo rm -rf /var/lib/cassandra/commitlog/</code></pre>
</div>
</div>
</li>
<li>
<p>Delete all the data files from each of the &lt;keyspace&gt;/&lt;table&gt; directories.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo rm /var/lib/cassandra/data/&lt;keyspace&gt;/&lt;table&gt;/*.*</code></pre>
</div>
</div>
</li>
<li>
<p>Move all the backed up data files into the correct &lt;keyspace&gt;/&lt;table&gt; directories.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo mv /&lt;backups&gt;/&lt;keyspace&gt;/&lt;table&gt;/*.db /var/lib/cassandra/data/&lt;keyspace&gt;/&lt;table&gt;/</code></pre>
</div>
</div>
</li>
<li>
<p>Start the Cassandra service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo service cassandra start</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refresh_the_data">Refresh the Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>What is it:</strong>
The second restore method is to move the backed up data files into place and using the multipurpose <code>nodetool</code> to refresh the cluster.
The process involves swapping in the sstable data file(s) directly into the keyspace/column family directories and telling Cassandra to reload the new files.</p>
</div>
<div class="paragraph">
<p><strong>When to use it:</strong>
This method is for when you have a brand new node to replace a node that has been unrecoverable.
There was never any trace of existing data, so all you’re doing is putting the backed up data into the correct directories and issuing the refresh command via nodetool.</p>
</div>
<div class="paragraph">
<p><strong>Steps to do it:</strong>  This is the easiest method to restore data.  Assuming you’ve created a new node that is running a clean install of Cassandra.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Recreate the schema on the clean Cassandra install using the backed up schema file (you are backing up your schema, right?).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cqlsh -E my_schema_file.cql</code></pre>
</div>
</div>
</li>
<li>
<p>Move all the backed up data files into the correct &lt;keyspace&gt;/&lt;table&gt; directories.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo mv /&lt;backups&gt;/&lt;keyspace&gt;/&lt;table&gt;/*.db /var/lib/cassandra/data/&lt;keyspace&gt;/&lt;table&gt;/</code></pre>
</div>
</div>
</li>
<li>
<p>Run the nodetool refresh command to tell Cassandra to reload it’s data files.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">nodetool refresh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sstableloader">SSTableLoader</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>What is it:</strong>
The third, and final, restore method is to use the sstableloader tool.
This tool is included in the Apache distribution of Cassandra.
Its purpose is, as it sounds, to load Cassandra sstable(s) into the cluster.
It’s not quick and it takes up a lot of additional disk space, but it does work.</p>
</div>
<div class="paragraph">
<p><strong>When to use it:</strong>
There is really only one or two reasons to follow this route for restoring data.
The first reason would be if you wanted to change from using tokens in an existing cluster and migrate the same data to use vnodes in a new cluster.
The second reason would be if you wished to restore your data into a cluster that has either a different replication factor or a different number of nodes that cluster that the data was backed up from.
Granted, neither of these situations are meant to recover data.
However, it’s still a valid way to restore backed up data</p>
</div>
<div class="paragraph">
<p><strong>Steps to do it:</strong>
This is a very time-consuming task as it involves reading each and every record in the sstable(s) and then writing each of them out to the correct node as dictated by the configured replication factor.
The records will follow the same write path as if the data were being written for the first time.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Recreate the schema on the clean Cassandra install using the backed up schema file (you are backing up your schema, right?).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cqlsh -E my_schema_file.cql</code></pre>
</div>
</div>
</li>
<li>
<p>Run the sstableloader command from each of the locations of the backed up data files.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sstableloader /&lt;backups&gt;/&lt;keyspace&gt;/&lt;table&gt;/</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat step 2 for each keyspace/table combination that you are restoring.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This post has walked you through the three ways to restore data into Cassandra.
You should now be able to assess when each method should be used.
As well as how to execute each method.
As great as it is to know who to do each of these, you need to test your knowledge.
Don’t just rely on reading a post and think you’ll know what to do when the crisis occurs.
Go out and test each of the scenarios out.
Make sure to time your efforts.
One day, you’ll be glad that you can answer your boss when you’re asked “how long before we’re back online?”.</p>
</div>
</div>
</div>

      </div>

      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
